import {
  ComputeOptions,
  computeValue
} from "../../core";
import { assert, groupBy, has } from "../../util";
const ID_KEY = "_id";
const $group = (collection, expr, options) => {
<<<<<<< HEAD
<<<<<<< HEAD
  assert(has(expr, ID_KEY), "a group specification must include an _id");
  const idExpr = expr[ID_KEY];
  const copts = ComputeOptions.init(options);
=======
=======
>>>>>>> cfa17b8e4 (favorite)
  assert(has(expr, ID_KEY), "$group specification must include an '_id'");
  const idExpr = expr[ID_KEY];
  const copts = ComputeOptions.init(options);
  const newFields = Object.keys(expr).filter((k) => k != ID_KEY);
<<<<<<< HEAD
>>>>>>> 7cb31df57 (se integro la edicion de las recetas)
=======
>>>>>>> cfa17b8e4 (favorite)
  return collection.transform((coll) => {
    const partitions = groupBy(
      coll,
      (obj) => computeValue(obj, idExpr, null, options),
      options.hashFunction
    );
<<<<<<< HEAD
<<<<<<< HEAD
    expr = { ...expr };
    delete expr[ID_KEY];
    let i = -1;
    const partitionKeys = Array.from(partitions.keys());
    const size = partitions.size;
    return () => {
      if (++i === size)
        return { done: true };
=======
=======
>>>>>>> cfa17b8e4 (favorite)
    let i = -1;
    const partitionKeys = Array.from(partitions.keys());
    return () => {
      if (++i === partitions.size) return { done: true };
<<<<<<< HEAD
>>>>>>> 7cb31df57 (se integro la edicion de las recetas)
=======
>>>>>>> cfa17b8e4 (favorite)
      const groupId = partitionKeys[i];
      const obj = {};
      if (groupId !== void 0) {
        obj[ID_KEY] = groupId;
      }
<<<<<<< HEAD
<<<<<<< HEAD
      for (const [key, val] of Object.entries(expr)) {
        obj[key] = computeValue(
          partitions.get(groupId),
          val,
          key,
=======
=======
>>>>>>> cfa17b8e4 (favorite)
      for (const key of newFields) {
        obj[key] = computeValue(
          partitions.get(groupId),
          expr[key],
          null,
<<<<<<< HEAD
>>>>>>> 7cb31df57 (se integro la edicion de las recetas)
=======
>>>>>>> cfa17b8e4 (favorite)
          copts.update(null, { groupId })
        );
      }
      return { value: obj, done: false };
    };
  });
};
export {
  $group
};
